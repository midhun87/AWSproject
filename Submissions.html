<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Donations - ReWear</title>
    <script src="/script.js"></script>
    <style>
      /* Re-use most of your existing CSS from userhome.html for consistency */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(to right, #fdfcfb, #e2d1c3);
        color: #333;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Header */
      header {
        background: linear-gradient(135deg, #222831, #393e46);
        color: #ffd369;
        padding: 2rem 1rem;
        text-align: center;
        position: relative;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      header h1 {
        font-size: 2.8rem;
        font-weight: 700;
        letter-spacing: 2px;
      }

      /* Navigation */
      nav {
        position: absolute;
        top: 1.5rem;
        right: 2rem;
        display: flex;
        gap: 1rem;
      }

      .dropbtn {
        background: #00adb5;
        color: #fff;
        padding: 0.6rem 1rem;
        font-size: 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.3s ease;
      }

      .dropbtn:hover {
        background: #019ca3;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #fff;
        min-width: 160px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        z-index: 2;
        border-radius: 6px;
        overflow: hidden;
        right: 0;
      }

      .dropdown-content a,
      .dropdown-content button {
        color: #333;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        font-size: 1rem;
        transition: background 0.3s ease;
        background: none;
        width: 100%;
        text-align: left;
        border: none;
      }

      .dropdown-content a:hover,
      .dropdown-content button:hover {
        background-color: #f5f5f5;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }

      /* Main Section */
      main {
        flex: 1;
        padding: 2rem;
        margin: 2rem auto;
        width: 90%;
        max-width: 1200px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      main:hover {
        transform: scale(1.01);
      }

      main h2 {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: #222831;
      }

      #my-posts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
        justify-content: center;
      }

      .post-box {
        background: #f8f9fa;
        border-radius: 15px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        width: 320px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
      }

      .post-box:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      }

      .post-box img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        transition: 0.3s ease;
      }

      .post-box img:hover {
        filter: brightness(0.95);
      }

      .post-box .info {
        padding: 1rem;
        text-align: center;
      }

      .post-box .info h3 {
        font-size: 1.2rem;
        color: #00797c;
        margin-bottom: 0.5rem;
      }

      .post-box .info p {
        font-size: 0.95rem;
        color: #444;
      }

      /* Claims Section Styling */
      .claims-section {
        margin-top: 1rem;
        border-top: 1px solid #eee;
        padding: 1rem;
        text-align: left;
        background-color: #f0f8ff; /* Light blue background for claims */
        border-radius: 0 0 15px 15px;
      }

      .claims-section h4 {
        font-size: 1rem;
        color: #222831;
        margin-bottom: 0.8rem;
        text-align: center;
      }

      .claim-item {
        background-color: #e6f7ff; /* Slightly darker blue for individual claims */
        border-left: 4px solid #3b82f6; /* Blue border for emphasis */
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        font-size: 0.9rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .claim-item p {
        margin: 0.2rem 0;
      }

      .no-claims {
        text-align: center;
        color: #666;
        font-style: italic;
        font-size: 0.9em;
      }


      /* Footer */
      footer {
        background-color: #222831;
        color: #eee;
        text-align: center;
        padding: 1.2rem;
        font-size: 1rem;
        margin-top: auto;
      }

      footer a {
        color: #ffd369;
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      /* Responsive */
      @media (max-width: 768px) {
        nav {
          flex-direction: column;
          top: auto;
          position: static;
          align-items: flex-end;
        }

        .post-box {
          width: 90%;
        }

        main {
          width: 95%;
          padding: 1.5rem;
        }
      }
    </style>
</head>
<body>
    <header>
        <h1><svg width="280" height="80" viewBox="0 0 320 100" xmlns="http://www.w3.org/2000/svg">
            <style>
                .highlight { font: bold 36px 'Poppins', sans-serif; fill: #ddab15; }
                .text-white { font: bold 36px 'Poppins', sans-serif; fill: #fff; }
                .hanger { stroke: #ddab15; stroke-width: 4; fill: none; }
            </style>

            <circle cx="50" cy="50" r="40" stroke="#ddab15" stroke-width="4" fill="none" />
            <path d="M30 45 Q50 20, 70 45 L50 70 Z" class="hanger"/>
            <circle cx="50" cy="35" r="3" fill="#ddab15" />

            <text x="100" y="60">
                <tspan class="highlight">Re</tspan>
                <tspan class="text-white">Wear</tspan>
            </text>
        </svg>
        </h1>
        <nav>
            <div class="dropdown">
                <button class="dropbtn">Profile</button>
                <div class="dropdown-content">
                    <a href="#" id="account-name">Account Name</a>
                    <a href="#" id="user-id">User ID</a>
                    <a href="./Submissions.html">Donations</a>
                    <button class="logout-button" onClick="logout()">Logout</button>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <center><h2>My Donations</h2></center>

        <section id="my-posts-container">
            <p style="text-align: center; margin-top: 20px; color: #555;">Loading your donations...</p>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 ReWear. Designed with purpose and passion.</p>
    </footer>

    <script>
        // This script block handles the page-specific logic for Submissions.html
        // The core 'valid()', 'logout()', and 'arrayBufferToBase64()' functions
        // are expected to be in your external '/script.js' file.

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await valid(); // Calls valid() from script.js
            if (user) {
                document.getElementById('account-name').innerText = user.username;
                document.getElementById('user-id').innerText = user.userId.substring(0,6);
                loadMySubmissions(); // Page-specific function to load user's donations
            } else {
                // If valid() returns null (not authenticated), valid() already redirects
                // So no need for an else block here.
            }
        });

        // Function specific to this page to load user's submissions/donations
        async function loadMySubmissions() {
            try {
                const token = localStorage.getItem('token'); // Use 'token' as per your script.js
                if (!token) {
                    // This check is a fallback; valid() should have redirected already
                    alert('Authentication token missing. Please log in.');
                    window.location.href = '/Login';
                    return;
                }

                const response = await fetch('/api/my-submissions', {
                    headers: {
                        'Authorization': `Bearer ${token}` // IMPORTANT: Send token with 'Bearer ' prefix
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('token'); // Clear expired/invalid token
                        alert('Your session has expired. Please log in again.');
                        window.location.href = '/Login';
                    } else {
                        // Log the error to console for debugging
                        const errorText = await response.text();
                        console.error('Failed to fetch my submissions. Server response:', response.status, errorText);
                        throw new Error(`Failed to fetch my submissions: ${response.statusText || errorText}`);
                    }
                }

                const submissions = await response.json();
                const myPostsContainer = document.getElementById('my-posts-container');
                myPostsContainer.innerHTML = ''; // Clear existing posts

                if (submissions.length === 0) {
                    myPostsContainer.innerHTML = '<p style="text-align: center; margin-top: 20px; color: #555;">You haven\'t made any donations yet.</p>';
                    return;
                }

                submissions.forEach(submission => {
                    const card = document.createElement('div');
                    card.classList.add('post-box');

                    const img = document.createElement('img');
                    // Ensure image data is correctly formatted for display
                    if (submission.image && submission.image.data && submission.image.data.data) {
                        img.src = `data:${submission.image.contentType};base64,${arrayBufferToBase64(submission.image.data.data)}`;
                    } else {
                        img.src = 'placeholder.jpg'; // Fallback if image data is missing
                        console.warn('Missing image data for submission:', submission._id);
                    }
                    img.alt = submission.name;

                    const info = document.createElement('div');
                    info.className = 'info';
                    info.innerHTML = `
                        <h3>${submission.name}</h3>
                        <p><strong>Email:</strong> ${submission.email}</p>
                        <p><strong>Mobile:</strong> ${submission.mobile}</p>
                        <p><strong>Location:</strong> ${submission.location}</p>
                        <p><strong>Posted On:</strong> ${new Date(submission.createdAt).toLocaleDateString()}</p>
                    `;

                    // Claims section
                    const claimsSection = document.createElement('div');
                    claimsSection.classList.add('claims-section');
                    claimsSection.innerHTML = '<h4>Claims Received:</h4>';

                    if (submission.claims && submission.claims.length > 0) {
                        submission.claims.forEach(claim => {
                            const claimItem = document.createElement('div');
                            claimItem.classList.add('claim-item');
                            claimItem.innerHTML = `
                                <p><strong>Name:</strong> ${claim.claimerName}</p>
                                <p><strong>Mobile:</strong> ${claim.claimerMobile}</p>
                                <p><strong>Email:</strong> ${claim.claimerEmail}</p>
                                <p><strong>Address:</strong> ${claim.claimerAddress}, ${claim.claimerState}</p>
                                <p><em>Claimed on: ${new Date(claim.claimedAt).toLocaleDateString()}</em></p>
                            `;
                            claimsSection.appendChild(claimItem);
                        });
                    } else {
                        claimsSection.innerHTML += '<p class="no-claims">No claims yet for this donation.</p>';
                    }

                    card.appendChild(img);
                    card.appendChild(info);
                    card.appendChild(claimsSection); // Append the claims section
                    myPostsContainer.appendChild(card);
                });
            } catch (err) {
                console.error('Failed to load my submissions:', err);
                document.getElementById('my-posts-container').innerHTML = '<p style="text-align:center; color:red;">An error occurred while loading your donations. Please try again.</p>';
            }
        }
    </script>
</body>
</html>